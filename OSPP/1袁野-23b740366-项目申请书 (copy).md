#                                                                                                       Project Application

| Project Name:              | Mogan Draw on WASM           |
| -------------------------- | ---------------------------- |
| Project Mentor:            | Shen Da                      |
| Applicant:                 | Yuan Ye                      |
| Date:                      | June 3, 2023                 |
| Applicant Email:           | origin020726@gmail.com       |
| Applicant GitHub Homepage: | https://github.com/Origin-yy |

## 1 项目背景

### 1.1 项目简介 

Mogan（墨干编辑器）是墨客实验室旗下的结构化编辑器。墨干编辑器在 TeXmacs 的基础上进行开发，旨在普及 GNU TeXmacs，让所有人都能够通过 Joris van der Hoeven 创造的软件享受探索科学与技术的乐趣。
###1.2 项目相关仓库 

Mogan 并不想拘束于单一平台，该项目在几乎所有平台都有维护，可以提交工单。

主要的平台如下：

+ GitHub: https://github.com/XmacsLabs/mogan
+  Gitee: https://gitee.com/XmacsLabs/mogan
+  Codeberg: https://codeberg.org/XmacsLabs

##2 项目需求

墨客实验室计划将墨干编辑器推广至中学课堂。本次开源之夏活动，我主要为墨干编辑器添加一些绘图方面的功能，并在此方向上进行一些改进和优化，使之能更好地为课堂服务。

「想象你是一名讲授欧几里德图形的高中教师，正准备用墨干编辑器/GNU TeXmacs准备幻灯片。」

### 2.1 用户界面重新设计:

Mathcha 的图形绘制为自己设定的固定图形模板通过移动和缩放来得到所需图形. 而 mogan 从点, 线开始, 通过手动绘制来创建自己所需的图形. 基于这一特点, mogan 可以获得对几何元素更加精细的把控, 但同时也带来了操作上的繁琐. 

目前, 我们在绘制图形时主要通过"选择工具栏的功能 -> 选择几何元素 -> 操作 -> 选择工具栏的另一个功能"的过程进行, 较为繁琐. 并且, "鼠标右键点击"功能的开发较少, "右键点击展开菜单"是大家的固有印象. 据此, 我们可以进行以下设计:  

1. 将选择功能独立出来, 鼠标样式为一个箭头, 作为平时的状态. 用户可以通过左键点击或者左键拖动框选来选择一个或者一组几何元素, 之后可以对选中的元素进行如下操作: 

   + 当鼠标左键点击时:

     展示一个类似于下图 Mathcha 的一个长方形边框 (边框带有八个点, 可以拖动每个点进行缩放)和一个代表旋转的点, 用户可以通过这里对选中的几何元素进行移动, 缩放, 旋转等操作. 

   + 当鼠标右键点击时:

     展示一个类似于上图 Mathcha 的一个菜单, 其中包括对选中几何元素的更多控制和编辑操作, 如: 分组/打散, 删除, 添加/删除名称, 显示坐标, 显示角度, 填充等操作.

2. 对上方的工具栏和菜单栏进行缩减,保留部分功能, 并将部分功能整合进鼠标右键中, 两者互相补充, 有重叠功能也有特有功能:
   + 当鼠标为选择功能时, 在空白处右键单击展示菜单, 包括工具栏中的一些功能, 如: 添加几何元素, 设置网格, 插入文字等操作. 

### 2.2 新特性和 bug 修复

1. 添加两点画圆的功能

   选择该功能后，鼠标点击的第一个点确定圆心，第二个点确定半径。绘制时可选是否显示圆心。

2. 增加绘制椭圆的功能

   选择该功能后，鼠标点击的前两个点确定两个焦点，第三个点为椭圆上一点，绘制时可选是否显示两个焦点。

3. 绘制扇形/圆弧

   选择该功能后，鼠标点击的第一个点为圆心，后两个点为两个半径，当圆心角为90度或180度时有一个吸附。

4. 实现各种箭头和装饰

   在箭头和箭身的下拉菜单里提供更多样式选项,  至少支持 quiver 上所有的箭头和箭身样式, 替换 TeXmacs 上默认的箭头样式（不够美观），使其和 quiver 一致。。

5. 显示角度

   如果用户选择一个为两条线段以上的交点，当右键单击展开菜单时, 可以选择为这个点为顶点的某个角添加角度, 以一小段圆弧标记夹角，直角则为直角标记。菜单中还可以选择: 删除角度标记, 添加/删除角的名称/角的度数,更改角的名称等操作(角度标记, 名称与角为一个整体).

6. 增加标识元素名称功能

   如果用户选择了一个几何元素（角，点，线，图形）等, 可以在右键展开的菜单中选择添加/删除名称，同时也可以更改标识元素名称和改变标识位置，标识和元素为一个整体。

7. 添加坐标显示功能

   如果用户选择了一个点, 可以在右键展开的菜单中选择显示坐标功能，该坐标与点为一个整体，可以拖动改变坐标显示位置,  也可以手动输入坐标来修改点的位置。

2.3 Mogan Draw：wasm 应用程序

在社区的帮助下将 Mogan Draw 托管在 https://draw.mogan.app 上, 使它成为一个尽可能小的独立的绘图应用程序.

2.3 制作相关文档和使用视频

通过Mogan Draw在Publicity: Euclid’s Element中重新绘制一些图形并制作视频展示绘制图形的详细步骤，然后上传到Bilibili或YouTube.

## 3 技术方法及可行性分析

| 相关代码文件                               | 功能                                      |
| ------------------------------------------ | ----------------------------------------- |
| `src/Graphics/Renderer/printer`            | 包含渲染器的打印功能                      |
| `src/Typeset/Concat/concat_graphics`       | 包含一些排版图形的函数，如`typeset_arc()` |
| `src/Plugins/Qt/qt_renderer`               | Qt的绘图接口                              |
| `TeXmacs/progs/graphics/graphics-menu.scm` | 工具栏的菜单展示                          |
| `src/Data/Drd/drd_std`                     | 完成用户选择的功能的操作                  |

| 数据结构                        | 功能                                                         |
| ------------------------------- | ------------------------------------------------------------ |
| `class tree`                    | 核心结构，它的叶子节点代表着不同类型的需要展现的元素，如曲线，点，直线，字符串等，以`t.rep->op`标签标识元素类型。 |
| `struct graphics_box_rep`       | 图形 box 类，包含根据鼠标位置或矩形区域选择图形元素的方法。  |
| `struct graphics_group_box_rep` | 图形组 box 类，包含选择整个图形组的方法。                    |
| `struct curve_box_rep`          | 曲线 box 类。包含曲线对象、画笔等，包含绘制曲线等方法。      |
| `class curve`                   | 代表曲线的类，通过一个`curve_rep`指针来表示一个曲线，一条曲线根据一组点和一组路径来绘制。 |

| 函数/方法                                    | 功能                                                         |
| -------------------------------------------- | ------------------------------------------------------------ |
| `void init_std_drd ()`                       | 根据用户选择创建的元素类型，初始化标签不同的`tree t`子树，并开始创建过程。 |
| `concater_rep::typeset (tree t, path ip)`    | 该函数被不断调用，传入带有不同标签的`tree t`子树，和当前位置的树路径，执行元素创建过程，根据标签进入对应的函数。当满足要添加的元素类型所需要的条件时，停止调用，将子树添加到原有树中。 |
| `void curve_box_rep::display (renderer ren)` | 曲线的绘制方法。                                             |


## 4. 项目产品设计

我们的产品主要服务于中学的几何教学,对于中学课堂的几何教学，主要会涉及以下内容：

1. 基本的几何元素的绘制：点，线段，直线，射线，角，四边形，圆形，三角形。

2. 几何图形的相关计算：角度计算,线段长度计算,图形面积计算.

3. 几何关系的证明:  角度相等,  线段平行,  面积相等.

对于一个讲授欧几里德图形课程的中学教师来说,  绘制图形时的方便程度和对几何图形的控制和描绘最为重要.  因此,  我们可以注重以下几点: 

1. 简单易用:

   可以直接在网页进行操作, 降低操作难度和学习成本.

2. 更加便捷的操作模式:

   减少对工具栏的依赖, 增加鼠标右键功能.

3. 对几何图形的控制: 

   移动，选择，旋转图形元素,  组合图形元素.

4. 对于几何元素描绘: 

   角度标记,  面积表示,  长度表示,  图形元素名称表示,  图形元素信息表示.

我们的主要功能集中在图形的绘制和信息展示方面,  满足中学几何课堂的教学和老师使用的需求. 

## 5. Timeline

| Week |              Dates              | Work                                                         |
| ---- | :-----------------------------: | :----------------------------------------------------------- |
| 0    |          Before July 1          | 继续熟悉项目，阅读代码，与导师沟通，深入理解项目相关的代码知识，学习`scheme`语言, 设计界面优化详细方案。并尝试自己的一些想法。 |
| 1    |       July 1st ~ July 7th       | 在社区的帮助下将 Mogan Draw 托管在 https://draw.mogan.app 上, 使它成为一个尽可能小的独立的绘图应用程序. |
| 2    |      July 8th ~ July 14th       | 进行用户界面优化并测试兼容性和稳定性.                        |
| 3    |      July 15th ~ July 21th      | 添加两点画圆的代码并进行测试，确保其正常工作。               |
| 4    |      July 22th ~ July 28th      | 添加绘制椭圆的代码并进行测试，确保其正常工作。               |
| 5    |     July 29th ~ August 4th      | 添加绘制扇形/圆弧的代码并进行测试，确保其正常工作。          |
| 6    |    August 5th ~ August 11th     | 实现各种箭头和装饰的功能并进行测试，确保其正常工作。         |
| 7    |    August 12th ~ August 18th    | 添加显示角度的代码并进行测试，确保其正常工作。               |
| 8    |    August 19th ~ August 25th    | 添加标识元素名称的代码并进行测试，确保其正常工作。           |
| 9    |   August 26th ~ September 1st   | 添加坐标显示功能代码并进行测试，确保其正常工作。             |
| 10   |  September 2nd ~ September 8th  | 对现有 Bug 的一些修复和优化.                                 |
| 11   | September 9th ~ September 15th  | 撰写相关设计文档和功能介绍文档                               |
| 12   | September 16th ~ September 22th | 通过Mogan Draw在Publicity: Euclid’s Element中重新绘制一些图形并制作视频展示绘制图形的详细步骤，然后上传到Bilibili或YouTube |

#### Buffer Time (8 days)

Allow for a buffer period of 8 days as a safety net, in case anything does not go as planned.

## 6. 期望

通过开源之夏活动, 我可以参与到开源项目的开发当中. 在项目中学习技术, 提高自己的代码水平, 同时开阔自己的眼界, 增加大型项目的开发经验. 



<img src="/home/origin/.config/Typora/typora-user-images/image-20230604104123244.png" alt="image-20230604104123244" style="zoom:50%;" />
